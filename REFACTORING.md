# Рефакторинг структуры проекта

## Проведенные изменения

### 1. Создана модульная структура `core/`

Новые модули для разделения ответственности:

- **`core/config.py`** — централизованная конфигурация из .env
  - Класс `Config` с типизированными полями
  - Единая точка доступа к параметрам через `config` singleton
  - Заменяет множественные вызовы `os.getenv()` по всему коду

- **`core/pixel_utils.py`** — утилиты работы с пикселями
  - `rgb_at()` — чтение цвета пикселя
  - `avg_rgb()` — усреднение по области
  - `avg_rgb_via_screencapture()` — захват через screencapture (Retina-safe)
  - `map_ready_pixel_xy()` — маппинг координат
  - `measure_ready_pixel_rgb()` — измерение READY_PIXEL с выбором источника

- **`core/telemetry.py`** — телеметрия и статистика
  - Класс `Telemetry` для отслеживания метрик
  - Методы `record_success()`, `record_failure()`, `to_dict()`
  - Заменяет локальный класс `_Telemetry` из windsurf_controller.py

- **`core/sleep_utils.py`** — утилиты задержек
  - `sleep_interruptible()` — прерываемый сон для Ctrl+C

### 2. Обновлен windsurf_controller.py

Изменения:
- ✅ Импорт новых модулей из `core.*`
- ✅ Удалены дублирующиеся функции (перенесены в core)
- ✅ Константы теперь читаются из `config` вместо прямого `os.getenv()`
- ✅ `Telemetry` импортируется вместо локального `_Telemetry`
- ✅ Метод `get_diagnostics()` обновлен для работы с новым Telemetry

### 3. Улучшения кода

- Типизация (type hints) для всех новых модулей
- Docstrings для публичных функций и классов
- Единообразный стиль обработки исключений
- Уменьшение дублирования кода

## Обратная совместимость

Все изменения **обратно совместимы**:
- API `DesktopController` не изменился
- Существующие вызовы функций работают через алиасы
- `.env` файл и параметры остались прежними
- Функциональность полностью сохранена

## Преимущества

1. **Модульность** — легко найти и изменить конфигурацию/утилиты
2. **Переиспользование** — утилиты можно использовать в других модулях
3. **Тестируемость** — модули можно тестировать независимо
4. **Читаемость** — код стал короче и понятнее
5. **Типизация** — лучшая поддержка IDE и меньше ошибок

## Структура после рефакторинга

```
vibe_coding/
├── core/
│   ├── __init__.py
│   ├── config.py          # Централизованная конфигурация
│   ├── pixel_utils.py     # Утилиты работы с пикселями
│   ├── telemetry.py       # Телеметрия и статистика
│   └── sleep_utils.py     # Утилиты задержек
├── handlers/
│   └── __init__.py        # Заготовка для будущих обработчиков команд
├── bot.py                 # Основной бот (без изменений)
├── windsurf_controller.py # Контроллер (обновлен)
├── mac_window_manager.py  # Без изменений
├── clipboard_utils.py     # Без изменений
├── selection.py           # Без изменений
├── text_filter.py         # Без изменений
└── ...                    # Остальные файлы без изменений
```

## Что НЕ изменилось

- `bot.py` — команды и логика бота
- `mac_window_manager.py` — работа с окнами macOS
- `clipboard_utils.py` — работа с буфером обмена
- `selection.py` — копирование из панели ответа
- `text_filter.py` — очистка текста и фильтрация эхо
- Все тесты и утилиты (healthcheck, color_pipette и т.д.)

## Следующие шаги (опционально)

Для дальнейшего улучшения можно:
- Вынести обработчики команд из bot.py в handlers/
- Создать `core/window_manager.py` для кроссплатформенной абстракции
- Добавить unit-тесты для новых модулей
- Создать `core/logger.py` для централизованного логирования
